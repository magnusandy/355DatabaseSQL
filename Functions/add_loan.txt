create or replace function add_loan(numkey inumkey, alphakey ialphakey, loan_datetime itdatetime, due_dateTime itdatetime, recipient clname) returns void as $$
declare
itemOwner clname;

begin
itemOwner:= (select i_clientkey from t_items where i_inumkey = numkey);
 
if ((select count(*) from t_items where i_inumkey = numkey and i_ialphakey = alphakey) <= 0) then
raise exception 'Error:The alphakey does not match the numkey';

elseif(select itemOwner not in (select cl_clname from v_us)) then
raise exception 'Error: We cannot lend an item that we dont own.';


elseif (itemOwner = recipient) then
raise exception 'Error: The owner of this item cannot borrow it';

elseif (loan_datetime > due_datetime) then
raise exception 'Error: Cannot have a return date before the item was borrowed';

end if;

-- Warn the user when an item is sold at midnight (they probably didn't specify a full date and time)
	IF ((SELECT EXTRACT(HOUR FROM CAST(loan_datetime AS timestamp)) = 0) 
		AND (SELECT EXTRACT(MINUTE FROM CAST(loan_datetime AS timestamp)) = 0) 
		AND (SELECT EXTRACT(SECOND FROM CAST(loan_datetime AS timestamp)) = 0)) THEN
		RAISE NOTICE 'Warning: Lending item  at midnight, are you sure you specified a date and time?';
	
end if;

insert into t_item_transactions(it_inumkey, it_ialphakey, it_clientkey, it_clname_proprietor, it_ittype, it_itdatetime_start, it_itdatetime_returnby, it_clname_recipient, it_itgross)
VALUES(
numkey,
alphakey,
(select i_clientkey from t_items where i_inumkey = numkey),
itemOwner,
'Loan',
loan_datetime,
due_dateTime,
recipient,
0
);

end;
$$ language plpgsql;

select add_loan(328, 'PA', cast('2014-11-30' as timestamp), cast('2015-02-15' as timestamp), 'Ryans Museum');

select add_loan(328, 'PA', cast('2014-11-30' as timestamp), cast('2015-02-15' as timestamp), 'Iain');

select add_loan(328, 'PA', cast('2014-11-30' as timestamp), cast('2014-11-29' as timestamp), 'Ryans Museum');

select add_loan(941, 'PA', cast('2014-11-30' as timestamp), cast('2015-02-15' as timestamp), 'Ryans Museum');

select add_loan(328, 'PWF', cast('2014-11-30' as timestamp), cast('2015-02-15' as timestamp), 'Ryans Museum');






